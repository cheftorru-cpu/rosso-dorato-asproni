<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rosso Dorato Asproni</title>
<style>
/* Stili semplici e leggibili per mobile */
body{background:#111;color:#eee;font-family:system-ui,Arial;padding:12px;min-height:100vh;box-sizing:border-box}
h1{ text-align:center; margin:8px 0 14px; font-size:1.3rem }
.card{background:#1c1c1c;border-radius:12px;padding:14px;margin-bottom:12px;box-sizing:border-box}
input,select,button,textarea{width:100%;padding:10px;margin:6px 0;border:none;border-radius:8px;font-size:15px;box-sizing:border-box}
button{background:#b11218;color:#fff;font-weight:600}
button.secondary{background:#333}
.month-card,.day-card,.fattura-card{border:1px solid #333;border-radius:10px;margin-bottom:10px;overflow:hidden}
.month-header,.day-header,.fattura-header{padding:12px;background:#222;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.month-body,.day-body,.fattura-body,.tot-body{display:none;padding:10px}
.small{color:#bbb;font-size:13px}
.sep{margin-top:10px;border-top:1px dashed #444;padding-top:8px}
.row{display:flex;justify-content:space-between;align-items:center}
.action{display:flex;gap:8px}
.action span{cursor:pointer}
.info{color:#bbb;font-size:13px}
.tot-header{cursor:pointer;font-weight:600;background:#161616;padding:8px;border-radius:6px;margin-bottom:8px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);justify-content:center;align-items:center;padding:12px;box-sizing:border-box}
.modal-box{background:#1c1c1c;border-radius:12px;padding:14px;width:100%;max-width:480px;max-height:85vh;overflow:auto}
.small-btn{background:#333;color:#fff;padding:8px;border-radius:8px;border:none;width:100%;margin-top:8px}
.debito{background:#ff6b35;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px}
@media(max-width:420px){ h1{font-size:1.1rem} input,button,select{font-size:14px} }
</style>
</head>
<body>
<h1>üç∑ Rosso Dorato Asproni</h1>

<!-- NUOVA GIORNATA -->
<div class="card">
  <h2>Nuova giornata</h2>
  <input type="date" id="data">
  <input type="number" id="incC" placeholder="Incassi contanti (es. 120.50)">
  <input type="number" id="incP" placeholder="Incassi POS">
  <input type="number" id="incS" placeholder="Incassi Sardex">
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button onclick="openModal('food')" style="flex:1">‚ûï Food</button>
    <button onclick="openModal('nonfood')" style="flex:1">‚ûï Non Food</button>
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button onclick="openModal('extra')" style="flex:1">‚ûï Extra</button>
    <button onclick="openModal('acconti')" style="flex:1">‚ûï Acconti</button>
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
    <button onclick="openModal('fatture')" style="flex:1;background:#444">üìÑ Aggiungi pagamento fattura</button>
    <button onclick="salva()" style="flex:1">üíæ Salva giornata</button>
  </div>
  <div class="info">Dopo il salvataggio puoi modificare gli incassi (bottone "Modifica incassi") o eliminare la giornata dallo storico.</div>
</div>

<!-- FATTURE APERTE -->
<div class="card">
  <h2>Fatture aperte</h2>
  <button class="secondary" onclick="nuovaFattura()">‚ûï Nuova fattura</button>
  <div id="fattureAperte" style="margin-top:8px"></div>
</div>

<!-- RIEPILOGO MESE -->
<div class="card">
  <h2>Riepilogo mese</h2>
  <select id="selMese" onchange="riepilogoMese()"></select>
  <button class="secondary" onclick="toggleAllDays()" style="margin-top:8px">üìä Mostra / Nascondi tutti i giorni</button>
  <div id="boxRiepilogo" class="small" style="margin-top:8px"></div>
</div>

<!-- STORICO -->
<div class="card">
  <h2>Storico giornate</h2>
  <div id="storico"></div>
</div>

<!-- MODALE GENERICO -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modTit"></h3>
    <input type="number" id="mImporto" placeholder="Importo">
    <input type="text" id="mNome" placeholder="Nome / Fornitore / Persona">
    <div style="display:flex;gap:8px">
      <button id="btnSave" class="small-btn" onclick="salvaVoce()">Aggiungi</button>
      <button class="small-btn" style="background:#555" onclick="closeModal()">Chiudi</button>
    </div>
    <div id="lista"></div>
  </div>
</div>

<script>
/* ===== Inizializzazione dati ===== */
let db = {};
let fatture = {};
try {
  db = JSON.parse(localStorage.getItem('rd')) || {};
  fatture = JSON.parse(localStorage.getItem('fatture')) || {};
} catch(e){
  db = {}; fatture = {};
}
let buffer = { food:[], nonfood:[], extra:[], acconti:[], fatture:[] };
let tipo = '';
let edit = null; // {m,gi,tipo,i}

/* ===== UI helpers ===== */
function openModal(t){
  tipo = t;
  edit = null;
  btnSave.innerText = 'Aggiungi';
  modTit.innerText = 'Aggiungi ' + t;
  modal.style.display = 'flex';
  renderModalList();
  if(t === 'fatture'){
    mNome.placeholder = 'ID fattura (scegli da Fatture aperte)';
    mImporto.placeholder = 'Importo (acconto da registrare oggi)';
  } else {
    mNome.placeholder = 'Nome / Fornitore / Persona';
    mImporto.placeholder = 'Importo';
  }
}
function closeModal(){ modal.style.display = 'none'; }
function renderModalList(){
  lista.innerHTML = '';
  (buffer[tipo]||[]).forEach((v,i)=>{
    lista.innerHTML += `<div class="list-item"><div>‚Ç¨${v.i.toFixed(2)} - ${v.n}</div><div style="cursor:pointer" onclick="buffer['${tipo}'].splice(${i},1);renderModalList()">‚ùå</div></div>`;
  });
}

/* salva voce in buffer (prima di salvare giornata) o modifica esistente */
function salvaVoce(){
  const imp = parseFloat(mImporto.value);
  const nome = (mNome.value || 'Senza nome').trim();
  if(!(imp>0)) return alert('Inserisci importo valido');
  if(edit){
    // modifica voce gi√† salvata nel db
    const v = db[edit.m][edit.gi][edit.tipo][edit.i];
    v.i = imp; v.n = nome;
    localStorage.setItem('rd', JSON.stringify(db));
    edit = null;
    mostraStorico();
    closeModal();
    return;
  }
  buffer[tipo].push({ i: imp, n: nome });
  mImporto.value = ''; mNome.value = '';
  renderModalList();
}

/* ===== SALVA GIORNATA ===== */
function salva(){
  if(!data.value) return alert('Inserisci la data');
  const monthKey = data.value.slice(0,7);
  if(!db[monthKey]) db[monthKey] = [];

  const c = parseFloat(incC.value) || 0;
  const p = parseFloat(incP.value) || 0;
  const s = parseFloat(incS.value) || 0;

  // Paga fatture buffer: se buffer.fatture contiene {id, i}, registriamo pagamenti come "extra" e aggiorniamo fatture
  const fatturePagate = [];
  const extraFromFatture = [];
  (buffer.fatture || []).forEach(fb => {
    if(fb.id && fatture[fb.id]){
      const f = fatture[fb.id];
      const daPagare = Math.min(f.tot - f.pagato, fb.i);
      if(daPagare > 0){
        extraFromFatture.push({ i: daPagare, n: `Pagamento fattura ${f.id} - ${f.fornitore}` });
        f.pagato = (f.pagato || 0) + daPagare;
        fatturePagate.push({ id: f.id, i: daPagare, n: `Pagamento fattura ${f.id} - ${f.fornitore}` });
        if(f.pagato >= f.tot) delete fatture[f.id];
      }
    }
  });

  const giornata = {
    data: data.value,
    contanti: c,
    pos: p,
    sardex: s,
    inc: c + p + s,
    food: [...buffer.food],
    nonfood: [...buffer.nonfood],
    extra: [...buffer.extra, ...extraFromFatture],
    acconti: [...buffer.acconti],
    fatturePagate: fatturePagate
  };

  db[monthKey].push(giornata);
  localStorage.setItem('rd', JSON.stringify(db));
  localStorage.setItem('fatture', JSON.stringify(fatture));

  // reset
  buffer = { food:[], nonfood:[], extra:[], acconti:[], fatture:[] };
  data.value = ''; incC.value=''; incP.value=''; incS.value='';
  mostraFatture(); mostraStorico(); alert('Giornata salvata ‚úÖ');
}

/* ===== FATTURE: aggiungi e paga ===== */
function nuovaFattura(){
  const tot = prompt('Importo totale fattura (es. 345.50):');
  if(tot === null) return;
  if(isNaN(parseFloat(tot)) || parseFloat(tot) <= 0) return alert('Importo non valido');
  const forn = prompt('Nome fornitore:');
  if(!forn) return alert('Fornitore obbligatorio');
  const id = 'F' + Date.now();
  fatture[id] = { id, tot: parseFloat(tot), fornitore: forn, pagato: 0 };
  localStorage.setItem('fatture', JSON.stringify(fatture));
  mostraFatture();
}

function mostraFatture(){
  const box = document.getElementById('fattureAperte');
  let html = '';
  const values = Object.values(fatture).sort((a,b)=>b.tot - a.tot);
  if(values.length === 0){ box.innerHTML = '<div class="small">Nessuna fattura aperta ‚úì</div>'; return; }
  values.forEach(f=>{
    const resto = (f.tot - (f.pagato||0));
    html += `<div class="fattura-card">
      <div class="fattura-header"><div>${f.fornitore} ‚Äî ${f.id}</div><div>Resto ‚Ç¨${resto.toFixed(2)} <span class="debito">Da pagare</span></div></div>
      <div class="fattura-body">
        <div class="small">Totale: ‚Ç¨${f.tot.toFixed(2)} ‚Ä¢ Pagato: ‚Ç¨${(f.pagato||0).toFixed(2)}</div>
        <input type="number" id="p_${f.id}" placeholder="Acconto da registrare oggi">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button onclick="pagaFatturaPrompt('${f.id}')" class="small-btn">üí∞ Registra pagamento</button>
          <button onclick="eliminaFattura('${f.id}')" class="small-btn" style="background:#8b0000">üóë Elimina fattura</button>
        </div>
      </div>
    </div>`;
  });
  box.innerHTML = html;
}

function pagaFatturaPrompt(id){
  const input = document.getElementById('p_' + id);
  const val = parseFloat(input.value || 0);
  if(!(val > 0)) return alert('Inserisci un importo valido');
  // chiedi a quale data associare la spesa (default: oggi)
  const date = prompt('Data pagamento (aaaa-mm-gg) in cui registrare la spesa (lascia vuoto = oggi):', new Date().toISOString().slice(0,10));
  if(date === null) return;
  pagaFattura(id, val, date);
  input.value = '';
}

function pagaFattura(id, importo, dataPago){
  if(!fatture[id]) return alert('Fattura non trovata');
  const f = fatture[id];
  const resto = f.tot - (f.pagato||0);
  const daPagare = Math.min(resto, parseFloat(importo) || 0);
  if(daPagare <= 0) return alert('Importo non valido o gi√† saldata');
  f.pagato = (f.pagato||0) + daPagare;
  if(f.pagato >= f.tot) delete fatture[id];
  localStorage.setItem('fatture', JSON.stringify(fatture));

  // aggiungi spesa al giorno scelto: se mese non esiste crealo
  const mk = (dataPago||new Date().toISOString().slice(0,10)).slice(0,7);
  if(!db[mk]) db[mk] = [];
  // se esiste gi√† giornata con quella data, usiamo prima giornata trovata con data uguale, altrimenti creiamone una
  let gi = db[mk].findIndex(g => g.data === (dataPago||new Date().toISOString().slice(0,10)));
  if(gi === -1){
    // crea nuova giornata vuota con inc 0
    db[mk].push({
      data: (dataPago||new Date().toISOString().slice(0,10)),
      contanti:0,pos:0,sardex:0,inc:0,
      food:[], nonfood:[], extra:[], acconti:[], fatturePagate:[]
    });
    gi = db[mk].length - 1;
  }
  // registra la spesa come extra e come fattura pagata nel giorno
  db[mk][gi].extra.push({ i: daPagare, n: `Pagamento fattura ${id} - ${f.fornitore}` });
  db[mk][gi].fatturePagate = db[mk][gi].fatturePagate || [];
  db[mk][gi].fatturePagate.push({ id, i: daPagare, n: `Pagamento fattura ${id} - ${f.fornitore}` });

  localStorage.setItem('rd', JSON.stringify(db));
  mostraFatture(); mostraStorico(); riepilogoMese();
  alert(`Registrato pagamento ‚Ç¨${daPagare.toFixed(2)} su ${db[mk][gi].data}`);
}

function eliminaFattura(id){
  if(!confirm('Eliminare fattura?')) return;
  delete fatture[id];
  localStorage.setItem('fatture', JSON.stringify(fatture));
  mostraFatture();
}

/* ===== modifica incassi giornata ===== */
function modificaIncassi(m,gi){
  const g = db[m][gi];
  const nc = prompt('Contanti (attuale: ‚Ç¨' + (g.contanti||0).toFixed(2) + ')', (g.contanti||0));
  if(nc === null) return;
  const np = prompt('POS (attuale: ‚Ç¨' + (g.pos||0).toFixed(2) + ')', (g.pos||0));
  if(np === null) return;
  const ns = prompt('Sardex (attuale: ‚Ç¨' + (g.sardex||0).toFixed(2) + ')', (g.sardex||0));
  if(ns === null) return;

  g.contanti = parseFloat(nc) || 0;
  g.pos = parseFloat(np) || 0;
  g.sardex = parseFloat(ns) || 0;
  g.inc = g.contanti + g.pos + g.sardex;

  localStorage.setItem('rd', JSON.stringify(db));
  mostraStorico(); riepilogoMese();
  alert('Incassi aggiornati ‚úÖ');
}

/* ===== elimina giorno ===== */
function eliminaGiornata(m,gi){
  if(!confirm('Eliminare l\'intera giornata?')) return;
  db[m].splice(gi,1);
  if(db[m].length === 0) delete db[m];
  localStorage.setItem('rd', JSON.stringify(db));
  mostraStorico(); riepilogoMese();
}

/* ===== funzioni di visualizzazione / calcolo ===== */
function toggle(el){
  if(!el) return;
  el.style.display = (el.style.display === 'block') ? 'none' : 'block';
}
function toggleAllDays(){
  document.querySelectorAll('.day-body').forEach(b => {
    b.style.display = (b.style.display === 'block') ? 'none' : 'block';
  });
}
function sommaPerNome(arr, map){
  (arr||[]).forEach(v => map[v.n] = (map[v.n]||0) + v.i);
}
function blocco(t, arr, m, gi, tipo){
  if(!arr || !arr.length) return `<div class="sep"><strong>${t} ‚Ç¨0.00</strong></div>`;
  let s = 0;
  const html = arr.map((v,i) => {
    s += v.i;
    return `<div class="row"><div>‚Ç¨${v.i.toFixed(2)} - ${v.n}</div><div class="action"><span title="Modifica" onclick="modificaVoce('${m}',${gi},'${tipo}',${i})">‚úèÔ∏è</span><span title="Elimina" onclick="eliminaVoce('${m}',${gi},'${tipo}',${i})">üóë</span></div></div>`;
  }).join('');
  return `<div class="sep"><strong>${t} ‚Ç¨${s.toFixed(2)}</strong>${html}</div>`;
}
function modificaVoce(m,gi,tipo,i){
  edit = {m,gi,tipo,i};
  const v = db[m][gi][tipo][i];
  mImporto.value = v.i;
  mNome.value = v.n;
  btnSave.innerText = 'Salva modifica';
  modTit.innerText = 'Modifica ' + tipo;
  modal.style.display = 'flex';
}
function eliminaVoce(m,gi,tipo,i){
  if(!confirm('Eliminare voce?')) return;
  db[m][gi][tipo].splice(i,1);
  localStorage.setItem('rd', JSON.stringify(db));
  mostraStorico(); riepilogoMese();
}

/* RIEPILOGO MESE: totali e breakdown per fornitore */
function riepilogoMese(){
  const sel = document.getElementById('selMese');
  const m = sel.value;
  if(!m || !db[m]) { boxRiepilogo.innerHTML = '<div class="info">Seleziona un mese con dati.</div>'; return; }

  let tot = { inc:0, contanti:0, pos:0, sardex:0, food:{}, nonfood:{}, extra:{}, acconti:{} };
  db[m].forEach(g => {
    tot.inc += g.inc || 0;
    tot.contanti += g.contanti || 0;
    tot.pos += g.pos || 0;
    tot.sardex += g.sardex || 0;
    sommaPerNome(g.food, tot.food);
    sommaPerNome(g.nonfood, tot.nonfood);
    sommaPerNome(g.extra, tot.extra);
    sommaPerNome(g.acconti, tot.acconti);
  });

  function bloccoTot(id, title, obj){
    const total = Object.values(obj).reduce((a,b)=>a+b,0);
    const lines = Object.keys(obj).map(k=>`<div>‚Ä¢ ${k}: ‚Ç¨${obj[k].toFixed(2)}</div>`).join('') || '<div>‚Äî</div>';
    return `<div class="sep"><div class="tot-header" onclick="toggle(document.getElementById('${id}'))">${title} ‚Ç¨${total.toFixed(2)}</div><div class="tot-body" id="${id}">${lines}</div></div>`;
  }

  boxRiepilogo.innerHTML = `
    <div class="tot-header">üìä Totali mese: Incassi ‚Ç¨${tot.inc.toFixed(2)} | Contanti ‚Ç¨${tot.contanti.toFixed(2)} | POS ‚Ç¨${tot.pos.toFixed(2)} | Sardex ‚Ç¨${tot.sardex.toFixed(2)}</div>
    ${bloccoTot('btf','Food', tot.food)}
    ${bloccoTot('btnf','Non Food', tot.nonfood)}
    ${bloccoTot('bte','Extra', tot.extra)}
    ${bloccoTot('bta','Acconti', tot.acconti)}
  `;
}

/* STORICO: mesi -> giorni (tutti a tendina). Ogni giorno mostra incassi dettagliati e liste con modifica/cancella */
function mostraStorico(){
  let html = '';
  const sel = document.getElementById('selMese');
  sel.innerHTML = '';
  const months = Object.keys(db).sort().reverse();
  months.forEach(m => {
    sel.options.add(new Option(m,m));
    let daysHtml = '';
    db[m].forEach((g, gi) => {
      const sp = [...(g.food||[]), ...(g.nonfood||[]), ...(g.extra||[])].reduce((t,x)=>t + (x.i||0), 0);
      const net = (g.inc||0) - sp;
      daysHtml += `
      <div class="day-card">
        <div class="day-header">
          <div style="flex:1;cursor:pointer" onclick="toggle(document.getElementById('d_${m}_${gi}'))">${formattaData(g.data)}</div>
          <div style="text-align:right">
            <div class="info">Netto ‚Ç¨${net.toFixed(2)}</div>
            <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
              <button class="small-btn" onclick="event.stopPropagation(); modificaIncassi('${m}',${gi})">Modifica incassi</button>
              <button class="small-btn" style="background:#8b0000" onclick="event.stopPropagation(); eliminaGiornata('${m}',${gi})">Elimina giornata</button>
            </div>
          </div>
        </div>
        <div class="day-body" id="d_${m}_${gi}">
          <div class="info">Incassi: Contanti ‚Ç¨${(g.contanti||0).toFixed(2)} ‚Ä¢ POS ‚Ç¨${(g.pos||0).toFixed(2)} ‚Ä¢ Sardex ‚Ç¨${(g.sardex||0).toFixed(2)}</div>
          ${blocco('Food', g.food, m, gi, 'food')}
          ${blocco('Non Food', g.nonfood, m, gi, 'nonfood')}
          ${blocco('Extra', g.extra, m, gi, 'extra')}
          ${blocco('Acconti', g.acconti, m, gi, 'acconti')}
          ${blocco('Fatture Pagate', g.fatturePagate || [], m, gi, 'fatturePagate')}
        </div>
      </div>`;
    });
    html += `<div class="month-card"><div class="month-header" onclick="toggle(this.nextElementSibling)">${m}</div><div class="month-body">${daysHtml}</div></div>`;
  });
  document.getElementById('storico').innerHTML = html;
  if(sel.options.length) sel.selectedIndex = 0;
  riepilogoMese();
}

/* formattazione data */
function formattaData(d){
  const x = new Date(d);
  return `${String(x.getDate()).padStart(2,'0')}/${String(x.getMonth()+1).padStart(2,'0')}/${x.getFullYear()}`;
}

/* inizializzazione UI */
mostraFatture();
mostraStorico();

</script>
</body>
</html>
