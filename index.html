<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Rosso Dorato Asproni</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{background:#111;color:#eee;font-family:system-ui,Arial;padding:15px;min-height:100vh}
h1{text-align:center;font-size:1.4em;margin:10px 0}
.card{background:#1c1c1c;border-radius:12px;padding:20px;margin-bottom:15px}
input,button,select{width:100%;padding:14px;margin:8px 0;border:none;border-radius:8px;font-size:16px;box-sizing:border-box}
button{background:#b11218;color:#fff;font-weight:600;font-size:16px;touch-action:manipulation}
button.secondary{background:#333}
.month-card,.day-card,.fattura-card{border:1px solid #333;border-radius:10px;margin-bottom:10px;overflow:hidden}
.month-header,.day-header,.fattura-header{padding:15px;background:#222;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600;touch-action:manipulation}
.month-body,.day-body,.tot-body,.fattura-body{display:none;padding:15px}
.small{color:#bbb;font-size:14px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);justify-content:center;align-items:center;padding:20px;box-sizing:border-box}
.modal-box{background:#1c1c1c;border-radius:16px;padding:25px;width:95%;max-width:420px;max-height:80vh;overflow-y:auto}
.list-item{display:flex;justify-content:space-between;font-size:16px;padding:12px 0;border-bottom:1px solid #333}
.sep{margin-top:12px;border-top:1px dashed #444;padding-top:12px}
.tot-header,.fattura-header{cursor:pointer;font-weight:600;padding:12px;background:#1a1a1a;border-radius:8px;margin:6px 0;display:flex;justify-content:space-between;touch-action:manipulation}
.row{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
.action span{cursor:pointer;margin-left:12px;font-size:20px;padding:4px;touch-action:manipulation}
.tot-row,.fatt-row{padding:8px 0;font-size:16px}
.debito{background:#ff6b35;color:#fff;padding:4px 8px;border-radius:4px;font-size:14px}
@media (max-width:480px){
  body{padding:10px}
  .card{padding:18px}
  .action span{margin-left:8px;font-size:18px}
}
</style>
</head>

<body>
<h1>üç∑ Rosso Dorato Asproni</h1>

<div class="card">
<h2>Nuova giornata</h2>
<input type="date" id="data">
<input type="number" id="incC" placeholder="Incassi contanti">
<input type="number" id="incP" placeholder="Incassi POS">
<input type="number" id="incS" placeholder="Sardex">
<button onclick="openModal('food')">‚ûï Food</button>
<button onclick="openModal('nonfood')">‚ûï Non Food</button>
<button onclick="openModal('extra')">‚ûï Extra</button>
<button onclick="openModal('acconti')">‚ûï Acconti</button>
<button onclick="openModal('fatture')">‚ûï Fatture Merce</button>
<button onclick="salva()">üíæ Salva giornata</button>
</div>

<div class="card">
<h2>üìã Fatture aperte</h2>
<button class="secondary" onclick="nuovaFattura()" style="margin-bottom:10px">‚ûï Nuova fattura</button>
<div id="fattureAperte"></div>
</div>

<div class="card">
<h2>Riepilogo mese</h2>
<select id="selMese" onchange="riepilogoMese()"></select>
<button class="secondary" onclick="toggleAllDays()">üìä Tutti i giorni</button>
<div id="boxRiepilogo" class="small"></div>
</div>

<div class="card">
<h2>Storico giornate</h2>
<div id="storico"></div>
</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modTit"></h3>
    <input type="number" id="mImporto" placeholder="Importo">
    <input type="text" id="mNome" placeholder="Nome / Fornitore / Persona">
    <button id="btnSave" onclick="salvaVoce()">Aggiungi</button>
    <div id="lista"></div>
    <button class="secondary" onclick="closeModal()">Chiudi</button>
  </div>
</div>

<script>
let db = {}; let fatture = {};
try {
  db = JSON.parse(localStorage.getItem("rd")) || {};
  fatture = JSON.parse(localStorage.getItem("fatture")) || {};
} catch(e) {
  db = {}; fatture = {};
}
let buffer = {food:[],nonfood:[],extra:[],acconti:[],fatture:[]};
let tipo=""; let edit=null;

function openModal(t){
  tipo=t;
  edit=null;
  btnSave.innerText="Aggiungi";
  modTit.innerText="Aggiungi "+t;
  modal.style.display="flex";
  render();
  if(t==="fatture"){
    mNome.style.display="none";
    mImporto.placeholder="Seleziona fattura da sezione 'Fatture aperte'";
  } else {
    mNome.style.display="block";
    mImporto.placeholder="Importo";
  }
}

function closeModal(){ modal.style.display="none"; }

function salvaVoce(){
  if(+mImporto.value<=0) return alert("Importo non valido");
  
  if(edit){
    let v=db[edit.m][edit.gi][edit.tipo][edit.i];
    v.i=+mImporto.value; v.n=mNome.value||"Senza nome";
    localStorage.setItem("rd",JSON.stringify(db));
    edit=null; mostraStorico();
  }else if(tipo==="fatture"){
    alert("Per le fatture usa la sezione 'Fatture aperte' o il bottone 'Paga acconto'");
    return;
  }else{
    buffer[tipo].push({i:+mImporto.value,n:mNome.value||"Senza nome"});
  }
  mImporto.value=""; mNome.value=""; render();
}

function render(){
  lista.innerHTML="";
  (buffer[tipo]||[]).forEach((v,i)=>{
    lista.innerHTML+=`<div class="list-item"><span>‚Ç¨${v.i} - ${v.n}</span><span onclick="buffer[tipo].splice(${i},1);render()">‚ùå</span></div>`;
  });
}

function salva(){
  if(!data.value) return alert("Inserisci la data");
  let m=data.value.slice(0,7);
  if(!db[m]) db[m]=[];

  let c=+incC.value||0,p=+incP.value||0,s=+incS.value||0;
  let giornata = {
    data:data.value,
    contanti:c,pos:p,sardex:s,inc:c+p+s,
    food:[...buffer.food],
    nonfood:[...buffer.nonfood],
    extra:[...buffer.extra],
    acconti:[...buffer.acconti],
    fatturePagate:[]
  };

  // Processa pagamenti fatture dal buffer (solo se hanno ID valido)
  buffer.fatture.forEach(f=>{
    if(f.id && fatture[f.id]){
      let resto = fatture[f.id].tot - fatture[f.id].pagato;
      let pagato = Math.min(f.i, resto);
      if(pagato>0){
        giornata.extra.push({i:pagato,n:`Pagamento fattura ${fatture[f.id].fornitore} (${fatture[f.id].id})`});
        giornata.fatturePagate.push({i:pagato,n:`Pagamento fattura ${fatture[f.id].fornitore} (${fatture[f.id].id})`});
        fatture[f.id].pagato += pagato;
        if(fatture[f.id].pagato >= fatture[f.id].tot) delete fatture[f.id];
      }
    }
  });

  db[m].push(giornata);
  localStorage.setItem("rd",JSON.stringify(db));
  localStorage.setItem("fatture",JSON.stringify(fatture));
  
  buffer={food:[],nonfood:[],extra:[],acconti:[],fatture:[]};
  data.value=""; incC.value=""; incP.value=""; incS.value="";
  mostraFatture(); mostraStorico(); riepilogoMese();
  alert("Giornata salvata!");
}

function nuovaFattura(){
  let tot = prompt("Totale fattura:");
  let forn = prompt("Fornitore:");
  if(tot && forn && !isNaN(tot)){
    let id = 'F'+Date.now();
    fatture[id] = {id,tot:+tot,fornitore:forn,pagato:0};
    localStorage.setItem("fatture",JSON.stringify(fatture));
    mostraFatture();
  } else {
    alert("Inserisci totale e fornitore validi");
  }
}

function pagaFattura(id,importo){
  if(!fatture[id]) return;
  let resto = fatture[id].tot - fatture[id].pagato;
  let daPagare = Math.min(+importo||0, resto);
  if(daPagare>0){
    fatture[id].pagato += daPagare;
    if(fatture[id].pagato >= fatture[id].tot) delete fatture[id];
    localStorage.setItem("fatture",JSON.stringify(fatture));
    mostraFatture();
    alert(`Pagato acconto ‚Ç¨${daPagare} su fattura ${fatture[id]?.id || id}`);
  }
}

function mostraFatture(){
  let h="";
  Object.values(fatture).sort((a,b)=>b.tot-a.tot).forEach(f=>{
    let resto = f.tot - f.pagato;
    h+=`
    <div class="fattura-card">
      <div class="fattura-header" onclick="toggle(this.nextElementSibling)">
        ${f.fornitore} (${f.id}) <span>‚Ç¨${resto.toFixed(2)} resto <span class="debito">Da pagare</span></span>
      </div>
      <div class="fattura-body">
        <div class="fatt-row">Totale: ‚Ç¨${f.tot.toFixed(2)}</div>
        <div class="fatt-row">Pagato: ‚Ç¨${f.pagato.toFixed(2)}</div>
        <div class="fatt-row">Resto: ‚Ç¨${resto.toFixed(2)}</div>
        <input type="number" id="p${f.id}" placeholder="Acconto oggi" style="margin:10px 0">
        <button onclick="pagaFattura('${f.id}',document.getElementById('p${f.id}').value)">üí∞ Paga acconto</button>
      </div>
    </div>`;
  });
  fattureAperte.innerHTML = Object.keys(fatture).length ? h : '<div class="small">Nessuna fattura aperta ‚úì</div>';
}

function toggle(el){ el.style.display=el.style.display==="block"?"none":"block"; }

function toggleAllDays(){
  let bodies=document.querySelectorAll('.day-body');
  let visibili=bodies[0] && bodies[0].style.display==="block";
  bodies.forEach(b=>b.style.display=visibili?"none":"block");
}

function riepilogoMese(){
  let m=selMese.value;
  if(!m || !db[m]) return boxRiepilogo.innerHTML="";
  
  let tot={inc:0,sp:0,net:0};
  db[m].forEach(g=>{
    tot.inc+=g.inc;
    let sp=[...g.food,...g.nonfood,...g.extra].reduce((t,x)=>t+x.i,0);
    tot.sp+=sp;
  });
  tot.net=tot.inc-tot.sp;
  
  boxRiepilogo.innerHTML=`
    <div class="tot-header" onclick="toggle(this.nextElementSibling)">
      üìä Totali mese: Incassi ‚Ç¨${tot.inc.toFixed(2)} | Spese ‚Ç¨${tot.sp.toFixed(2)} | Netto ‚Ç¨${tot.net.toFixed(2)}
    </div>
    <div class="tot-body">
      ${db[m].map((g,i)=>`<div class="tot-header" onclick="toggle(this.nextElementSibling)">${g.data}: ‚Ç¨${g.inc.toFixed(2)} incassi | ‚Ç¨${(g.inc-[...g.food,...g.nonfood,...g.extra].reduce((t,x)=>t+x.i,0)).toFixed(2)} netto</div><div class="tot-body"><div class="tot-row"><strong>Contanti:</strong> ‚Ç¨${g.contanti.toFixed(2)}</div><div class="tot-row"><strong>POS:</strong> ‚Ç¨${g.pos.toFixed(2)}</div><div class="tot-row"><strong>Sardex:</strong> ‚Ç¨${g.sardex.toFixed(2)}</div></div>`).join('')}
    </div>`;
}

function mostraStorico(){
  let h=""; selMese.innerHTML="";
  Object.keys(db).sort().reverse().forEach(m=>{
    selMese.options.add(new Option(m,m));
    let d="";
    db[m].forEach((g,i)=>{
      let sp=[...g.food,...g.nonfood,...g.extra].reduce((t,x)=>t+x.i,0);
      let net=g.inc-sp;
      d+=`
      <div class="day-card">
        <div class="day-header" onclick="toggle(document.getElementById('d${m}${i}'))">
          ${g.data} <span>‚Ç¨${net.toFixed(2)} netto (inc:‚Ç¨${g.inc.toFixed(2)} sp:‚Ç¨${sp.toFixed(2)})</span>
        </div>
        <div class="day-body" id="d${m}${i}">
          ${blocco("Food",g.food,m,i,"food")}
          ${blocco("Non Food",g.nonfood,m,i,"nonfood")}
          ${blocco("Extra",g.extra,m,i,"extra")}
          ${blocco("Acconti",g.acconti,m,i,"acconti")}
          ${blocco("Fatture Pagate",g.fatturePagate || [],m,i,"fatturePagate")}
        </div>
      </div>`;
    });
    h+=`<div class="month-card"><div class="month-header" onclick="toggle(this.nextElementSibling)">${m}</div><div class="month-body">${d}</div></div>`;
  });
  storico.innerHTML=h;
  if(selMese.options.length) selMese.selectedIndex=0;
  riepilogoMese();
}

function blocco(t,a,m,gi,tipo){
  let s=0,h="";
  a.forEach((v,i)=>{
    s+=v.i;
    h+=`<div class="row"><div>‚Ç¨${v.i.toFixed(2)} - ${v.n}</div><div class="action"><span onclick="modificaVoce('${m}',${gi},'${tipo}',${i})" title="Modifica">‚úèÔ∏è</span><span onclick="eliminaVoce('${m}',${gi},'${tipo}',${i})" title="Cancella">üóë</span></div></div>`;
  });
  return h?`<div class="sep"><strong>${t} ‚Ç¨${s.toFixed(2)}</strong>${h}</div>`:"";
}

function modificaVoce(m,gi,tipo,i){
  edit={m,gi,tipo,i};
  let v=db[m][gi][tipo][i];
  mImporto.value=v.i; mNome.value=v.n; mNome.style.display="block";
  btnSave.innerText="Salva modifica"; modTit.innerText="Modifica "+tipo;
  modal.style.display="flex";
}

function eliminaVoce(m,gi,tipo,i){
  if(!confirm("Eliminare voce?")) return;
  db[m][gi][tipo].splice(i,1);
  localStorage.setItem("rd",JSON.stringify(db));
  mostraStorico();
}

mostraFatture(); mostraStorico();
</script>
</body>
</html>
