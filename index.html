<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Rosso Dorato Asproni</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#111;color:#eee;font-family:system-ui,Arial;padding:15px;min-height:100vh}
h1{text-align:center}
.card{background:#1c1c1c;border-radius:12px;padding:15px;margin-bottom:15px}
input,button,select{width:100%;padding:10px;margin:6px 0;border:none;border-radius:8px;box-sizing:border-box}
button{background:#b11218;color:#fff;font-weight:600}
button.secondary{background:#333}
.month-card,.day-card{border:1px solid #333;border-radius:10px;margin-bottom:10px;overflow:hidden}
.month-header,.day-header{padding:10px;background:#222;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.month-body,.day-body{display:none;padding:10px}
.small{color:#bbb;font-size:14px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);justify-content:center;align-items:center}
.modal-box{background:#1c1c1c;border-radius:12px;padding:15px;width:90%;max-width:420px}
.list-item{display:flex;justify-content:space-between;font-size:14px;margin-top:4px}
.sep{margin-top:8px;border-top:1px dashed #444;padding-top:6px}
.tot-header{cursor:pointer;font-weight:600;background:#1a1a1a;padding:8px;border-radius:6px}
.tot-body{display:none;padding:8px}
.row{display:flex;justify-content:space-between;align-items:center}
.action span{cursor:pointer;margin-left:8px}
.small-btn{background:#333;color:#fff;padding:8px;border-radius:8px;border:none;width:100%;margin-top:6px}
.info{color:#bbb;font-size:13px}
</style>
</head>
<body>
<h1>üç∑ Rosso Dorato Asproni</h1>

<div class="card">
  <h2>Nuova giornata</h2>
  <input type="date" id="data">
  <input type="number" id="incC" placeholder="Incassi contanti">
  <input type="number" id="incP" placeholder="Incassi POS">
  <input type="number" id="incS" placeholder="Incassi Sardex">
  <button onclick="openModal('food')">‚ûï Food</button>
  <button onclick="openModal('nonfood')">‚ûï Non Food</button>
  <button onclick="openModal('extra')">‚ûï Extra</button>
  <button onclick="openModal('acconti')">‚ûï Acconti</button>
  <button onclick="salva()">üíæ Salva giornata</button>
  <div class="info">Dopo il salvataggio puoi modificare gli incassi con il bottone "Modifica incassi" nel riepilogo mese o eliminare l'intera giornata dallo storico.</div>
</div>

<div class="card">
  <h2>Riepilogo mese</h2>
  <select id="selMese" onchange="riepilogoMese()"></select>
  <div id="boxRiepilogo" class="small"></div>
</div>

<div class="card">
  <h2>Storico giornate</h2>
  <div id="storico"></div>
</div>

<!-- MODALE per aggiungere/modificare voci -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modTit"></h3>
    <input type="number" id="mImporto" placeholder="Importo">
    <input type="text" id="mNome" placeholder="Nome / Fornitore / Persona">
    <div style="display:flex;gap:8px">
      <button id="btnSave" class="small-btn" onclick="salvaVoce()">Aggiungi</button>
      <button class="small-btn" style="background:#555" onclick="closeModal()">Chiudi</button>
    </div>
    <div id="lista"></div>
  </div>
</div>

<script>
/* ===== dati iniziali ===== */
let db = JSON.parse(localStorage.getItem("rd")) || {};
let buffer = {food:[],nonfood:[],extra:[],acconti:[]};
let tipo=""; let edit=null; // edit = {m,gi,tipo,i}

/* ===== helper UI ===== */
function openModal(t){
  tipo=t; edit=null;
  btnSave.innerText="Aggiungi";
  modTit.innerText = "Aggiungi " + t;
  modal.style.display = "flex";
  render();
}
function closeModal(){ modal.style.display="none"; }
function render(){
  lista.innerHTML = "";
  (buffer[tipo]||[]).forEach((v,i)=>{
    lista.innerHTML += `<div class="list-item"><div>‚Ç¨${v.i.toFixed(2)} - ${v.n}</div><div style="cursor:pointer" onclick="buffer['${tipo}'].splice(${i},1);render()">‚ùå</div></div>`;
  });
}

/* ===== aggiunta / modifica voce nel buffer (prima di salvare la giornata) ===== */
function salvaVoce(){
  if(+mImporto.value <= 0) return alert("Importo non valido");
  if(edit){
    // modifica voce gi√† salvata in db
    const v = db[edit.m][edit.gi][edit.tipo][edit.i];
    v.i = +mImporto.value;
    v.n = mNome.value || "Senza nome";
    localStorage.setItem("rd", JSON.stringify(db));
    edit = null;
    mostraStorico();
    closeModal();
    return;
  }
  buffer[tipo].push({i:+mImporto.value, n: mNome.value || "Senza nome"});
  mImporto.value = ""; mNome.value = "";
  render();
}

/* ===== salva giornata ===== */
function salva(){
  if(!data.value) return alert("Inserisci la data");
  let m = data.value.slice(0,7);
  if(!db[m]) db[m] = [];

  let c = +incC.value || 0;
  let p = +incP.value || 0;
  let s = +incS.value || 0;

  db[m].push({
    data: data.value,
    contanti: c,
    pos: p,
    sardex: s,
    inc: c + p + s,
    food: [...buffer.food],
    nonfood: [...buffer.nonfood],
    extra: [...buffer.extra],
    acconti: [...buffer.acconti]
  });

  localStorage.setItem("rd", JSON.stringify(db));
  buffer = {food:[],nonfood:[],extra:[],acconti:[]};
  data.value=""; incC.value=""; incP.value=""; incS.value="";
  mostraStorico();
  alert("Giornata salvata ‚úÖ");
}

/* ===== modifica incassi giornata (prompt semplice) ===== */
function modificaIncassi(m,gi){
  const g = db[m][gi];
  let nc = prompt("Contanti (attuale: ‚Ç¨" + (g.contanti||0).toFixed(2) + ")", (g.contanti||0));
  if(nc === null) return; // annulla
  let np = prompt("POS (attuale: ‚Ç¨" + (g.pos||0).toFixed(2) + ")", (g.pos||0));
  if(np === null) return;
  let ns = prompt("Sardex (attuale: ‚Ç¨" + (g.sardex||0).toFixed(2) + ")", (g.sardex||0));
  if(ns === null) return;

  g.contanti = parseFloat(nc) || 0;
  g.pos = parseFloat(np) || 0;
  g.sardex = parseFloat(ns) || 0;
  g.inc = g.contanti + g.pos + g.sardex;

  localStorage.setItem("rd", JSON.stringify(db));
  mostraStorico();
  riepilogoMese();
  alert("Incassi aggiornati ‚úÖ");
}

/* ===== elimina intera giornata ===== */
function eliminaGiornata(m,gi){
  if(!confirm("Eliminare l'intera giornata?")) return;
  db[m].splice(gi,1);
  if(db[m].length===0) delete db[m];
  localStorage.setItem("rd", JSON.stringify(db));
  mostraStorico();
  riepilogoMese();
}

/* ===== funzioni di visualizzazione e calcolo ===== */
function toggle(el){ el.style.display = el.style.display==="block" ? "none" : "block"; }

function sommaPerNome(arr,map){
  (arr||[]).forEach(v => map[v.n] = (map[v.n]||0) + v.i );
}

function blocco(t,arr,m,gi,tipo){
  if(!arr || !arr.length) return `<div class="sep"><strong>${t} ‚Ç¨0.00</strong></div>`;
  let s = 0;
  let html = arr.map((v,i)=>{
    s += v.i;
    // singola voce con modifica/elimina
    return `<div class="row"><div>‚Ç¨${v.i.toFixed(2)} - ${v.n}</div><div class="action"><span onclick="modificaVoce('${m}',${gi},'${tipo}',${i})">‚úèÔ∏è</span><span onclick="eliminaVoce('${m}',${gi},'${tipo}',${i})">üóë</span></div></div>`;
  }).join("");
  return `<div class="sep"><strong>${t} ‚Ç¨${s.toFixed(2)}</strong>${html}</div>`;
}

function modificaVoce(m,gi,tipo,i){
  edit = {m,gi,tipo,i};
  const v = db[m][gi][tipo][i];
  mImporto.value = v.i;
  mNome.value = v.n;
  btnSave.innerText = "Salva modifica";
  modTit.innerText = "Modifica " + tipo;
  modal.style.display = "flex";
}

function eliminaVoce(m,gi,tipo,i){
  if(!confirm("Eliminare voce?")) return;
  db[m][gi][tipo].splice(i,1);
  localStorage.setItem("rd", JSON.stringify(db));
  mostraStorico();
  riepilogoMese();
}

/* riepilogo mese con breakdown incassi contanti/POS/Sardex e lista giorni con dettaglio */
function riepilogoMese(){
  const sel = document.getElementById("selMese");
  const m = sel.value;
  if(!m || !db[m]) { boxRiepilogo.innerHTML = "<div class='info'>Seleziona un mese con dati.</div>"; return; }

  let tot = {inc:0, contanti:0, pos:0, sardex:0, food:{}, nonfood:{}, extra:{}, acconti:{}};
  db[m].forEach(g=>{
    tot.inc += g.inc || 0;
    tot.contanti += g.contanti || 0;
    tot.pos += g.pos || 0;
    tot.sardex += g.sardex || 0;
    sommaPerNome(g.food, tot.food);
    sommaPerNome(g.nonfood, tot.nonfood);
    sommaPerNome(g.extra, tot.extra);
    sommaPerNome(g.acconti, tot.acconti);
  });

  function bloccoTot(tid, title, obj){
    let totVal = Object.values(obj).reduce((a,b)=>a+b,0);
    let htmlLines = Object.keys(obj).map(k=>`<div>‚Ä¢ ${k}: ‚Ç¨${obj[k].toFixed(2)}</div>`).join("");
    return `<div class="sep"><div class="tot-header" onclick="toggle(document.getElementById('${tid}'))">${title} ‚Ç¨${totVal.toFixed(2)}</div><div class="tot-body" id="${tid}">${htmlLines || '<div>‚Äî</div>'}</div></div>`;
  }

  boxRiepilogo.innerHTML = `
    <div class="tot-header">üìä Totali mese: Incassi ‚Ç¨${tot.inc.toFixed(2)} | Contanti ‚Ç¨${tot.contanti.toFixed(2)} | POS ‚Ç¨${tot.pos.toFixed(2)} | Sardex ‚Ç¨${tot.sardex.toFixed(2)}</div>
    ${bloccoTot("bt_food","Food",tot.food)}
    ${bloccoTot("bt_nonfood","Non Food",tot.nonfood)}
    ${bloccoTot("bt_extra","Extra",tot.extra)}
    ${bloccoTot("bt_acconti","Acconti",tot.acconti)}
  `;
}

/* storico giorno per giorno con pulsanti modifica incassi ed elimina giornata */
function mostraStorico(){
  let html = "";
  selMese.innerHTML = "";
  Object.keys(db).sort().reverse().forEach(m=>{
    selMese.options.add(new Option(m,m));
    let daysHtml = "";
    db[m].forEach((g,gi)=>{
      let sp = [...(g.food||[]), ...(g.nonfood||[]), ...(g.extra||[])].reduce((t,x)=>t+x.i,0);
      let net = (g.inc||0) - sp;
      daysHtml += `
      <div class="day-card">
        <div class="day-header">
          <div style="flex:1;cursor:pointer" onclick="toggle(document.getElementById('${m}_${gi}'))">${formattaData(g.data)}</div>
          <div style="text-align:right;">
            <div class="info">Netto ‚Ç¨${net.toFixed(2)}</div>
            <div style="font-size:13px;margin-top:6px">
              <button class="small-btn" onclick="event.stopPropagation(); modificaIncassi('${m}',${gi})">Modifica incassi</button>
              <button class="small-btn" style="background:#8b0000" onclick="event.stopPropagation(); eliminaGiornata('${m}',${gi})">Elimina giornata</button>
            </div>
          </div>
        </div>
        <div class="day-body" id="${m}_${gi}">
          <div class="info">Incassi: Contanti ‚Ç¨${(g.contanti||0).toFixed(2)} ‚Ä¢ POS ‚Ç¨${(g.pos||0).toFixed(2)} ‚Ä¢ Sardex ‚Ç¨${(g.sardex||0).toFixed(2)}</div>
          ${blocco("Food", g.food, m, gi, "food")}
          ${blocco("Non Food", g.nonfood, m, gi, "nonfood")}
          ${blocco("Extra", g.extra, m, gi, "extra")}
          ${blocco("Acconti", g.acconti, m, gi, "acconti")}
        </div>
      </div>`;
    });
    html += `<div class="month-card"><div class="month-header" onclick="toggle(this.nextElementSibling)">${m}</div><div class="month-body">${daysHtml}</div></div>`;
  });
  storico.innerHTML = html;
  if(selMese.options.length) selMese.selectedIndex = 0;
  riepilogoMese();
}

/* utile */
function formattaData(d){
  const x = new Date(d);
  return `${String(x.getDate()).padStart(2,'0')}/${String(x.getMonth()+1).padStart(2,'0')}/${x.getFullYear()}`;
}

/* inizializza UI */
mostraStorico();
</script>
</body>
</html>
