<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Rosso Dorato Asproni</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{background:#111;color:#eee;font-family:system-ui,Arial;padding:15px}
h1{text-align:center}
.card{background:#1c1c1c;border-radius:12px;padding:15px;margin-bottom:15px}
input,button,select{width:100%;padding:10px;margin:6px 0;border:none;border-radius:8px}
button{background:#b11218;color:#fff;font-weight:600}
button.secondary{background:#333}
button.danger{background:#555;color:#fff}
.month-card,.day-card{border:1px solid #333;border-radius:10px;margin-bottom:10px}
.month-header,.day-header{padding:10px;background:#222;cursor:pointer;display:flex;justify-content:space-between}
.month-body,.day-body{display:none;padding:10px}
.small{color:#bbb;font-size:14px}
.sep{margin-top:8px;border-top:1px dashed #444;padding-top:6px}
.tot-header{cursor:pointer;font-weight:600}
.tot-body{display:none;padding-left:10px}
</style>
</head>

<body>
<h1>üç∑ Rosso Dorato Asproni</h1>

<div class="card">
<h2>Nuova giornata</h2>
<input type="date" id="data">
<input type="number" id="incC" placeholder="Incassi contanti">
<input type="number" id="incP" placeholder="Incassi POS">
<input type="number" id="incS" placeholder="Sardex">
<button onclick="openModal('food')">‚ûï Food</button>
<button onclick="openModal('nonfood')">‚ûï Non Food</button>
<button onclick="openModal('extra')">‚ûï Extra</button>
<button onclick="openModal('acconti')">‚ûï Acconti</button>
<button onclick="salva()">üíæ Salva giornata</button>
</div>

<div class="card">
<h2>Riepilogo mese</h2>
<select id="selMese" onchange="riepilogoMese()"></select>
<div id="boxRiepilogo" class="small"></div>
</div>

<div class="card">
<h2>Storico giornate</h2>
<div id="storico"></div>
</div>

<div class="card">
<button class="danger" onclick="resettaDati()">üóëÔ∏è Cancella TUTTI i dati</button>
</div>

<script>
let db = JSON.parse(localStorage.getItem("rd")) || {};

function resettaDati(){
  if(!confirm("ATTENZIONE!\nVuoi cancellare TUTTI i dati?\nOperazione irreversibile.")) return;
  localStorage.removeItem("rd");
  db = {};
  mostraStorico();
  alert("Dati cancellati. Puoi reinserire tutto da capo.");
}

function toggle(el){
  el.style.display = el.style.display==="block" ? "none" : "block";
}

function sommaPerNome(arr,map){
  (arr||[]).forEach(v=>{
    map[v.n]=(map[v.n]||0)+v.i;
  });
}

function blocco(t,a){
  if(!a || !a.length) return `<div class="sep"><strong>${t} ‚Ç¨0</strong></div>`;
  let s=0,h="";
  a.forEach(v=>{
    s+=v.i;
    h+=`<div>‚Ä¢ ${v.n}: ‚Ç¨${v.i}</div>`;
  });
  return `<div class="sep"><strong>${t} ‚Ç¨${s}</strong>${h}</div>`;
}

/* ===== INCASSI GIORNO ===== */
function bloccoIncassiGiorno(g){
  let tot=(g.contanti||0)+(g.pos||0)+(g.sardex||0);
  return `
  <div class="sep">
    <div class="tot-header" onclick="toggle(this.nextElementSibling)">
      Incassi ‚Ç¨${tot}
    </div>
    <div class="tot-body">
      <div>‚Ä¢ Contanti: ‚Ç¨${g.contanti||0}</div>
      <div>‚Ä¢ POS: ‚Ç¨${g.pos||0}</div>
      <div>‚Ä¢ Sardex: ‚Ç¨${g.sardex||0}</div>
    </div>
  </div>`;
}

/* ===== RIEPILOGO MESE ===== */

function bloccoTot(id,t,o){
  let tot=0,h="";
  Object.keys(o).forEach(k=>{
    tot+=o[k];
    h+=`<div>‚Ä¢ ${k}: ‚Ç¨${o[k]}</div>`;
  });
  return `
  <div class="sep">
    <div class="tot-header" onclick="toggle(document.getElementById('${id}'))">
      ${t} ‚Ç¨${tot}
    </div>
    <div class="tot-body" id="${id}">${h}</div>
  </div>`;
}

function riepilogoMese(){
  let m=selMese.value;
  if(!db[m]) return;

  let inc=0,c=0,p=0,s=0;
  let tot={food:{},nonfood:{},extra:{},acconti:{}};

  db[m].forEach(g=>{
    inc+=g.inc||0;
    c+=g.contanti||0;
    p+=g.pos||0;
    s+=g.sardex||0;
    sommaPerNome(g.food,tot.food);
    sommaPerNome(g.nonfood,tot.nonfood);
    sommaPerNome(g.extra,tot.extra);
    sommaPerNome(g.acconti,tot.acconti);
  });

  boxRiepilogo.innerHTML=`
    <strong>Incassi Totali ‚Ç¨${inc}</strong>
    ${bloccoTot("inc","Incassi",{Contanti:c,POS:p,Sardex:s})}
    ${bloccoTot("f","Food",tot.food)}
    ${bloccoTot("nf","Non Food",tot.nonfood)}
    ${bloccoTot("e","Extra",tot.extra)}
    ${bloccoTot("a","Acconti",tot.acconti)}
  `;
}

/* ===== STORICO ===== */

function mostraStorico(){
  let html="";
  Object.keys(db).sort().reverse().forEach((m,mi)=>{
    let days="";
    db[m].forEach((g,i)=>{
      let sp=[...(g.food||[]),...(g.nonfood||[]),...(g.extra||[])].reduce((t,x)=>t+x.i,0);
      days+=`
      <div class="day-card">
        <div class="day-header" onclick="toggle(document.getElementById('d${mi}_${i}'))">
          ${g.data} <span>‚Ç¨${(g.inc||0)-sp}</span>
        </div>
        <div class="day-body" id="d${mi}_${i}">
          ${bloccoIncassiGiorno(g)}
          ${blocco("Food",g.food)}
          ${blocco("Non Food",g.nonfood)}
          ${blocco("Extra",g.extra)}
          ${blocco("Acconti",g.acconti)}
        </div>
      </div>`;
    });
    html+=`
    <div class="month-card">
      <div class="month-header" onclick="toggle(document.getElementById('m${mi}'))">${m}</div>
      <div class="month-body" id="m${mi}">${days}</div>
    </div>`;
  });

  storico.innerHTML=html;
  selMese.innerHTML = Object.keys(db).sort().reverse().map(m=>`<option>${m}</option>`).join("");
  riepilogoMese();
}

mostraStorico();
</script>
</body>
</html>
