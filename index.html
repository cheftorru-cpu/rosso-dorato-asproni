<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Rosso Dorato Asproni</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{background:#111;color:#eee;font-family:system-ui,Arial;padding:15px}
h1{text-align:center}
.card{background:#1c1c1c;border-radius:12px;padding:15px;margin-bottom:15px}
input,button,select{width:100%;padding:10px;margin:6px 0;border:none;border-radius:8px}
button{background:#b11218;color:#fff;font-weight:600}
button.secondary{background:#333}
.month-card,.day-card{border:1px solid #333;border-radius:10px;margin-bottom:10px}
.month-header,.day-header{padding:10px;background:#222;cursor:pointer;display:flex;justify-content:space-between}
.month-body,.day-body{display:none;padding:10px}
.small{color:#bbb;font-size:14px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);justify-content:center;align-items:center}
.modal-box{background:#1c1c1c;border-radius:12px;padding:15px;width:90%;max-width:420px}
.list-item{display:flex;justify-content:space-between;font-size:14px;margin-top:4px}
.sep{margin-top:8px;border-top:1px dashed #444;padding-top:6px}

.tot-header{cursor:pointer;font-weight:600}
.tot-body{display:none;padding-left:10px}
</style>
</head>

<body>
<h1>üç∑ Rosso Dorato Asproni</h1>

<div class="card">
<h2>Nuova giornata</h2>
<input type="date" id="data">
<input type="number" id="incC" placeholder="Incassi contanti">
<input type="number" id="incP" placeholder="Incassi POS">
<input type="number" id="incS" placeholder="Sardex">

<button onclick="openModal('food')">‚ûï Food</button>
<button onclick="openModal('nonfood')">‚ûï Non Food</button>
<button onclick="openModal('extra')">‚ûï Extra</button>
<button onclick="openModal('acconti')">‚ûï Acconti</button>
<button onclick="salva()">üíæ Salva giornata</button>
</div>

<div class="card">
<h2>Riepilogo mese</h2>
<select id="selMese" onchange="riepilogoMese()"></select>
<div id="boxRiepilogo" class="small"></div>
</div>

<div class="card">
<h2>Storico giornate</h2>
<div id="storico"></div>
</div>

<!-- MODALE -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modTit"></h3>
    <input type="number" id="mImporto" placeholder="Importo">
    <input type="text" id="mNome" placeholder="Nome / Fornitore / Persona">
    <button onclick="addVoce()">Aggiungi</button>
    <div id="lista"></div>
    <button class="secondary" onclick="closeModal()">Chiudi</button>
  </div>
</div>

<script>
/* DB in localStorage */
let db = JSON.parse(localStorage.getItem("rd")) || {};
let buffer = {food:[],nonfood:[],extra:[],acconti:[]};
let tipo="";

/* MODALE */
function openModal(t){ tipo=t; modTit.innerText="Aggiungi "+t; modal.style.display="flex"; render(); }
function closeModal(){ modal.style.display="none"; }

/* aggiungi voce temporanea */
function addVoce(){
  if(+mImporto.value<=0) return;
  buffer[tipo].push({i:+mImporto.value,n:mNome.value||"Senza nome"});
  mImporto.value=""; mNome.value="";
  render();
}
function render(){
  lista.innerHTML="";
  buffer[tipo].forEach((v,i)=>{
    lista.innerHTML+=`
    <div class="list-item">
      <span>‚Ç¨${v.i} - ${v.n}</span>
      <span onclick="buffer[tipo].splice(${i},1);render()">‚ùå</span>
    </div>`;
  });
}

/* salva giornata: adesso salviamo separatamente contanti/POS/Sardex oltre al totale */
function salva(){
  if(!data.value) return alert("Inserisci la data");
  // prendi valori numerici in modo sicuro (eviti NaN)
  const incCVal = Number(incC.value) || 0;
  const incPVal = Number(incP.value) || 0;
  const incSVal = Number(incS.value) || 0;
  const incTot = incCVal + incPVal + incSVal;

  let m=data.value.slice(0,7);
  if(!db[m]) db[m]=[];
  db[m].push({
    data: data.value,
    inc: incTot,
    incC: incCVal,
    incP: incPVal,
    incS: incSVal,
    food:[...buffer.food],
    nonfood:[...buffer.nonfood],
    extra:[...buffer.extra],
    acconti:[...buffer.acconti]
  });
  localStorage.setItem("rd",JSON.stringify(db));
  buffer={food:[],nonfood:[],extra:[],acconti:[]};
  // pulisci i campi della form (opzionale)
  incC.value=""; incP.value=""; incS.value=""; data.value="";
  mostraStorico();
}

/* toggle display helper */
function toggle(el){ el.style.display = el.style.display==="block" ? "none" : "block"; }

/* costruisce il blocco dettaglio (giorno o totale) */
function blocco(t,a){
  let s=0,h="";
  a.forEach(v=>{ s+=v.i; h+=`<div>‚Ç¨${v.i} - ${v.n}</div>` });
  return `<div class="sep"><strong>${t} ‚Ç¨${s}</strong>${h}</div>`;
}

/* mostra storico a mesi e giornate (menu espandibile) */
function mostraStorico(){
  let html="";
  const months = Object.keys(db).sort().reverse();
  months.forEach((m,mi)=>{
    let days="";
    db[m].forEach((g,i)=>{
      let sp = [...g.food,...g.nonfood,...g.extra].reduce((t,x)=>t + (Number(x.i)||0),0);
      days+=`
      <div class="day-card">
        <div class="day-header" onclick="toggle(document.getElementById('d${mi}_${i}'))">
          ${formattaData(g.data)} <span>‚Ç¨${g.inc - sp}</span>
        </div>
        <div class="day-body" id="d${mi}_${i}">
          ${blocco("Food",g.food)}
          ${blocco("Non Food",g.nonfood)}
          ${blocco("Extra",g.extra)}
          ${blocco("Acconti",g.acconti)}
          <div class="sep small">Dettaglio incassi: Contanti ‚Ç¨${g.incC || 0} ‚Ä¢ POS ‚Ç¨${g.incP || 0} ‚Ä¢ Sardex ‚Ç¨${g.incS || 0}</div>
        </div>
      </div>`;
    });
    html+=`
    <div class="month-card">
      <div class="month-header" onclick="toggle(document.getElementById('m${mi}'))">${m}</div>
      <div class="month-body" id="m${mi}">${days}</div>
    </div>`;
  });
  storico.innerHTML=html;

  // aggiorna select mesi per riepilogo
  selMese.innerHTML = months.map(mm => `<option value="${mm}">${mm}</option>`).join("");
  // seleziona il primo mese disponibile se nulla selezionato
  if(months.length && !selMese.value) selMese.value = months[0];
  riepilogoMese();
}

/* somma per nome per fare totali per fornitore/persona */
function sommaPerNome(arr,map){ arr.forEach(v=> map[v.n] = (map[v.n]||0) + (Number(v.i)||0) ); }

/* blocchi a tendina per i totali mensili (ogni blocco √® espandibile) */
function bloccoTot(id,t,o){
  let s=0,h="";
  Object.keys(o).forEach(k=>{
    s += o[k];
    h += `<div>‚Ä¢ ${k}: ‚Ç¨${o[k]}</div>`;
  });
  return `
    <div class="sep">
      <div class="tot-header" onclick="toggle(document.getElementById('${id}'))">${t} ‚Ç¨${s}</div>
      <div class="tot-body" id="${id}">${h}</div>
    </div>`;
}

/* RIEPILOGO MESE con dettaglio incassi contanti/POS/Sardex e subtotali per nome */
function riepilogoMese(){
  let m = selMese.value;
  if(!m || !db[m]) { boxRiepilogo.innerHTML = ""; return; }

  // accumuli
  let tot = { food:{}, nonfood:{}, extra:{}, acconti:{} };
  let incC=0, incP=0, incS=0, incTot=0;

  db[m].forEach(g=>{
    incC += Number(g.incC) || 0;
    incP += Number(g.incP) || 0;
    incS += Number(g.incS) || 0;
    incTot += Number(g.inc) || 0;
    sommaPerNome(g.food, tot.food);
    sommaPerNome(g.nonfood, tot.nonfood);
    sommaPerNome(g.extra, tot.extra);
    sommaPerNome(g.acconti, tot.acconti);
  });

  let spTot =
    Object.values(tot.food).reduce((a,b)=>a+b,0) +
    Object.values(tot.nonfood).reduce((a,b)=>a+b,0) +
    Object.values(tot.extra).reduce((a,b)=>a+b,0);

  boxRiepilogo.innerHTML = `
    <strong>Incassi Totali ‚Ç¨${incTot}</strong>
    <div class="sep small">
      <div class="tot-header" onclick="toggle(document.getElementById('incDet'))">Dettaglio incassi ‚Ç¨${incTot}</div>
      <div class="tot-body" id="incDet">
        <div>‚Ä¢ Contanti: ‚Ç¨${incC}</div>
        <div>‚Ä¢ POS: ‚Ç¨${incP}</div>
        <div>‚Ä¢ Sardex: ‚Ç¨${incS}</div>
      </div>
    </div>

    ${bloccoTot('tf','Food', tot.food)}
    ${bloccoTot('tnf','Non Food', tot.nonfood)}
    ${bloccoTot('te','Extra', tot.extra)}
    ${bloccoTot('ta','Acconti', tot.acconti)}

    <div class="sep"><strong>Utile ‚Ç¨${incTot - spTot}</strong></div>
  `;
}

/* helper: formatta data gg/mm/aaaa */
function formattaData(d){
  let x = new Date(d);
  return `${String(x.getDate()).padStart(2,'0')}/${String(x.getMonth()+1).padStart(2,'0')}/${x.getFullYear()}`;
}

/* inizializza vista */
mostraStorico();
</script>
</body>
</html>
