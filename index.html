<script>
let db = JSON.parse(localStorage.getItem("rd")) || {};
let buffer = {food:[],nonfood:[],extra:[],acconti:[]};
let tipo="";

function openModal(t){ tipo=t; modTit.innerText="Aggiungi "+t; modal.style.display="flex"; render(); }
function closeModal(){ modal.style.display="none"; }

function addVoce(){
  if(+mImporto.value<=0) return;
  buffer[tipo].push({i:+mImporto.value,n:mNome.value||"Senza nome"});
  mImporto.value=""; mNome.value="";
  render();
}
function render(){
  lista.innerHTML="";
  buffer[tipo].forEach((v,i)=>{
    lista.innerHTML+=`
    <div class="list-item">
      <span>€${v.i} - ${v.n}</span>
      <span onclick="buffer[tipo].splice(${i},1);render()">❌</span>
    </div>`;
  });
}

function salva(){
  if(!data.value) return alert("Inserisci la data");
  let m=data.value.slice(0,7);
  if(!db[m]) db[m]=[];

  let c=+incC.value||0;
  let p=+incP.value||0;
  let s=+incS.value||0;

  db[m].push({
    data:data.value,
    contanti:c,
    pos:p,
    sardex:s,
    inc:c+p+s,
    food:[...buffer.food],
    nonfood:[...buffer.nonfood],
    extra:[...buffer.extra],
    acconti:[...buffer.acconti]
  });

  localStorage.setItem("rd",JSON.stringify(db));
  buffer={food:[],nonfood:[],extra:[],acconti:[]};
  mostraStorico();
}

function toggle(el){
  el.style.display = el.style.display==="block"?"none":"block";
}

function sommaPerNome(arr,map){
  arr.forEach(v=> map[v.n]=(map[v.n]||0)+v.i );
}

function bloccoTot(id,t,o){
  let s=0,h="";
  Object.keys(o).forEach(k=>{
    s+=o[k];
    h+=`<div>• ${k}: €${o[k]}</div>`;
  });
  return `
  <div class="sep">
    <div class="tot-header" onclick="toggle(document.getElementById('${id}'))">
      ${t} €${s}
    </div>
    <div class="tot-body" id="${id}">${h}</div>
  </div>`;
}

function riepilogoMese(){
  let m=selMese.value;
  if(!db[m]) return;

  let tot={food:{},nonfood:{},extra:{},acconti:{}};
  let inc=0,c=0,p=0,s=0;

  db[m].forEach(g=>{
    let cc = g.contanti ?? g.inc ?? 0;
    let pp = g.pos ?? 0;
    let ss = g.sardex ?? 0;

    inc += g.inc || 0;
    c += cc;
    p += pp;
    s += ss;

    sommaPerNome(g.food||[],tot.food);
    sommaPerNome(g.nonfood||[],tot.nonfood);
    sommaPerNome(g.extra||[],tot.extra);
    sommaPerNome(g.acconti||[],tot.acconti);
  });

  let sp=[
    ...Object.values(tot.food),
    ...Object.values(tot.nonfood),
    ...Object.values(tot.extra)
  ].reduce((a,b)=>a+b,0);

  boxRiepilogo.innerHTML=`
    <strong>Incassi Totali €${inc}</strong>
    ${bloccoTot("inc","Dettaglio incassi",{Contanti:c,POS:p,Sardex:s})}
    ${bloccoTot("f","Food",tot.food)}
    ${bloccoTot("nf","Non Food",tot.nonfood)}
    ${bloccoTot("e","Extra",tot.extra)}
    ${bloccoTot("a","Acconti",tot.acconti)}
    <div class="sep"><strong>Utile €${inc-sp}</strong></div>
  `;
}

function mostraStorico(){
  let html="";
  Object.keys(db).sort().reverse().forEach((m,mi)=>{
    let days="";
    db[m].forEach((g,i)=>{
      let sp=[...(g.food||[]),...(g.nonfood||[]),...(g.extra||[])].reduce((t,x)=>t+x.i,0);

      let cc = g.contanti ?? g.inc ?? 0;
      let pp = g.pos ?? 0;
      let ss = g.sardex ?? 0;

      days+=`
      <div class="day-card">
        <div class="day-header" onclick="toggle(document.getElementById('d${mi}_${i}'))">
          ${formattaData(g.data)} <span>€${g.inc-sp}</span>
        </div>
        <div class="day-body" id="d${mi}_${i}">
          <div class="small">
            Contanti €${cc} · POS €${pp} · Sardex €${ss}
          </div>
          ${blocco("Food",g.food||[])}
          ${blocco("Non Food",g.nonfood||[])}
          ${blocco("Extra",g.extra||[])}
          ${blocco("Acconti",g.acconti||[])}
        </div>
      </div>`;
    });

    html+=`
    <div class="month-card">
      <div class="month-header" onclick="toggle(document.getElementById('m${mi}'))">${m}</div>
      <div class="month-body" id="m${mi}">${days}</div>
    </div>`;
  });

  storico.innerHTML=html;
  selMese.innerHTML = Object.keys(db).sort().reverse().map(m=>`<option>${m}</option>`).join("");
  riepilogoMese();
}

function blocco(t,a){
  let s=0,h="";
  a.forEach(v=>{s+=v.i;h+=`<div>€${v.i} - ${v.n}</div>`});
  return `<div class="sep"><strong>${t} €${s}</strong>${h}</div>`;
}

function formattaData(d){
  let x=new Date(d);
  return `${String(x.getDate()).padStart(2,'0')}/${String(x.getMonth()+1).padStart(2,'0')}/${x.getFullYear()}`;
}

mostraStorico();
      </script>
