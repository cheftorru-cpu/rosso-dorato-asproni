<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Rosso Dorato Asproni</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{background:#111;color:#eee;font-family:system-ui,Arial;padding:15px;min-height:100vh}
h1{text-align:center}
.card{background:#1c1c1c;border-radius:12px;padding:15px;margin-bottom:15px}
input,button,select{width:100%;padding:10px;margin:6px 0;border:none;border-radius:8px;box-sizing:border-box}
button{background:#b11218;color:#fff;font-weight:600}
button.secondary{background:#333}
.month-card,.day-card{border:1px solid #333;border-radius:10px;margin-bottom:10px}
.month-header,.day-header{padding:10px;background:#222;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.month-body,.day-body{display:none;padding:10px}
.small{color:#bbb;font-size:14px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);justify-content:center;align-items:center}
.modal-box{background:#1c1c1c;border-radius:12px;padding:15px;width:90%;max-width:420px}
.list-item{display:flex;justify-content:space-between;font-size:14px;margin-top:4px}
.sep{margin-top:8px;border-top:1px dashed #444;padding-top:6px}
.tot-header{cursor:pointer;font-weight:600}
.tot-body{display:none;padding-left:10px}
.row{display:flex;justify-content:space-between;align-items:center}
.action span{cursor:pointer;margin-left:8px}
.del{cursor:pointer;color:#f55}
small.note{display:block;color:#999;margin-top:6px}
</style>
</head>

<body>
<h1>üç∑ Rosso Dorato Asproni</h1>

<div class="card">
  <h2>Nuova giornata</h2>
  <input type="date" id="data">
  <input type="number" id="incC" placeholder="Incassi contanti">
  <input type="number" id="incP" placeholder="Incassi POS">
  <input type="number" id="incS" placeholder="Sardex">
  <div style="display:flex;gap:8px">
    <button onclick="openModal('food')" style="flex:1">‚ûï Food</button>
    <button onclick="openModal('nonfood')" style="flex:1">‚ûï Non Food</button>
  </div>
  <div style="display:flex;gap:8px">
    <button onclick="openModal('extra')" style="flex:1">‚ûï Extra</button>
    <button onclick="openModal('acconti')" style="flex:1">‚ûï Acconti</button>
  </div>
  <button onclick="salva()">üíæ Salva giornata</button>
  <small class="note">Dopo il salvataggio i singoli importi hanno il cestino per cancellare/modificare.</small>
</div>

<div class="card">
  <h2>Riepilogo mese</h2>
  <select id="selMese" onchange="riepilogoMese()"></select>
  <div id="boxRiepilogo" class="small"></div>
</div>

<div class="card">
  <h2>Storico giornate</h2>
  <div id="storico"></div>
</div>

<!-- MODALE -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modTit"></h3>
    <input type="number" id="mImporto" placeholder="Importo">
    <input type="text" id="mNome" placeholder="Nome / Fornitore / Persona">
    <button id="btnSave" onclick="salvaVoce()">Aggiungi</button>
    <div id="lista"></div>
    <button class="secondary" onclick="closeModal()">Chiudi</button>
  </div>
</div>

<script>
// riferimenti DOM (pi√π sicuro che usare variabili implicite)
const modTit = document.getElementById('modTit');
const mImporto = document.getElementById('mImporto');
const mNome = document.getElementById('mNome');
const lista = document.getElementById('lista');
const btnSave = document.getElementById('btnSave');
const selMese = document.getElementById('selMese');
const boxRiepilogo = document.getElementById('boxRiepilogo');
const storicoEl = document.getElementById('storico');

let db = JSON.parse(localStorage.getItem("rd")) || {};
let buffer = {food:[],nonfood:[],extra:[],acconti:[]};
let tipo="";
let edit = null; // {m,gi,tipo,i}

function openModal(t){
  tipo = t;
  edit = null;
  btnSave.innerText = "Aggiungi";
  modTit.innerText = "Aggiungi " + t;
  mImporto.value = "";
  mNome.value = "";
  lista.innerHTML = "";
  render();
  document.getElementById('modal').style.display = 'flex';
}
function closeModal(){ document.getElementById('modal').style.display = 'none'; }

function salvaVoce(){
  const val = Number(mImporto.value || 0);
  if(val <= 0) { alert("Importo non valido"); return; }

  if(edit){
    // modifica voce esistente
    const v = db[edit.m][edit.gi][edit.tipo][edit.i];
    v.i = val;
    v.n = mNome.value || "Senza nome";
    localStorage.setItem("rd", JSON.stringify(db));
    edit = null;
    closeModal();
    mostraStorico();
    aggiornaMesi();
    return;
  }

  // aggiungi a buffer (giornata non ancora salvata)
  buffer[tipo].push({i: val, n: mNome.value || "Senza nome"});
  mImporto.value = ""; mNome.value = "";
  render();
}

function render(){
  lista.innerHTML = "";
  const arr = buffer[tipo] || [];
  arr.forEach((v,i)=>{
    const r = document.createElement('div');
    r.className = 'list-item';
    r.innerHTML = `<div>‚Ç¨${v.i.toFixed(2)} - ${v.n}</div>
      <div><span style="cursor:pointer" onclick="buffer['${tipo}'].splice(${i},1); render()">‚ùå</span></div>`;
    lista.appendChild(r);
  });
}

function salva(){
  const data = document.getElementById('data').value;
  if(!data) return alert("Inserisci la data");
  const m = data.slice(0,7); // yyyy-mm
  if(!db[m]) db[m] = [];

  const c = Number(document.getElementById('incC').value || 0);
  const p = Number(document.getElementById('incP').value || 0);
  const s = Number(document.getElementById('incS').value || 0);

  const giornata = {
    data,
    contanti: c, pos: p, sardex: s, inc: c+p+s,
    food: [...buffer.food],
    nonfood: [...buffer.nonfood],
    extra: [...buffer.extra],
    acconti: [...buffer.acconti]
  };

  db[m].push(giornata);
  localStorage.setItem("rd", JSON.stringify(db));

  // reset form + buffer
  buffer = {food:[],nonfood:[],extra:[],acconti:[]};
  document.getElementById('data').value = "";
  document.getElementById('incC').value = "";
  document.getElementById('incP').value = "";
  document.getElementById('incS').value = "";

  aggiornaMesi();
  mostraStorico();
  riepilogoMese();
  alert("Giornata salvata ‚úÖ");
}

function modificaVoce(m,gi,tipo,i){
  edit = {m,gi,tipo,i};
  const v = db[m][gi][tipo][i];
  mImporto.value = v.i;
  mNome.value = v.n;
  btnSave.innerText = "Salva modifica";
  modTit.innerText = "Modifica " + tipo;
  document.getElementById('modal').style.display = 'flex';
}

function eliminaVoce(m,gi,tipo,i){
  if(!confirm("Eliminare voce?")) return;
  db[m][gi][tipo].splice(i,1);
  // se la giornata √® vuota si potrebbe cancellare l'intera giornata: non lo faccio automaticamente
  localStorage.setItem("rd", JSON.stringify(db));
  mostraStorico();
  riepilogoMese();
  aggiornaMesi();
}

function toggle(el){ el.style.display = el.style.display === "block" ? "none" : "block"; }

function aggiornaMesi(){
  // popola il select dei mesi
  selMese.innerHTML = "";
  const keys = Object.keys(db).sort().reverse();
  keys.forEach(k => selMese.options.add(new Option(k,k)));
  if(keys.length) selMese.selectedIndex = 0;
  // aggiorna riepilogo
  riepilogoMese();
}

function blocco(t,arr,m,gi,tipo){
  if(!arr || !arr.length) return '';
  let s = 0;
  let html = '';
  arr.forEach((v,i)=>{
    s += v.i;
    html += `<div class="row"><div>‚Ç¨${v.i.toFixed(2)} - ${v.n}</div>
      <div class="action"><span onclick="modificaVoce('${m}',${gi},'${tipo}',${i})">‚úèÔ∏è</span>
      <span onclick="eliminaVoce('${m}',${gi},'${tipo}',${i})">üóë</span></div></div>`;
  });
  return `<div class="sep"><strong>${t} ‚Ç¨${s.toFixed(2)}</strong>${html}</div>`;
}

function bloccoTot(id,title,obj){
  const keys = Object.keys(obj||{});
  const s = keys.reduce((a,k)=>a + (obj[k]||0), 0);
  const lines = keys.map(k=>`<div>‚Ä¢ ${k}: ‚Ç¨${(obj[k]||0).toFixed(2)}</div>`).join('');
  return `<div class="sep"><div class="tot-header" onclick="toggle(document.getElementById('${id}'))">${title} ‚Ç¨${s.toFixed(2)}</div>
    <div class="tot-body" id="${id}">${lines}</div></div>`;
}

function riepilogoMese(){
  const m = selMese.value;
  if(!m || !db[m]) { boxRiepilogo.innerHTML = ''; return; }

  const totNames = {food:{}, nonfood:{}, extra:{}, acconti:{}};
  let inc = 0, cont=0, pos=0, sard=0;

  db[m].forEach(g=>{
    inc += g.inc || 0;
    cont += g.contanti || 0;
    pos += g.pos || 0;
    sard += g.sardex || 0;
    sommaPerNome(g.food, totNames.food);
    sommaPerNome(g.nonfood, totNames.nonfood);
    sommaPerNome(g.extra, totNames.extra);
    sommaPerNome(g.acconti, totNames.acconti);
  });

  const sp = [...Object.values(totNames.food), ...Object.values(totNames.nonfood), ...Object.values(totNames.extra)]
    .reduce((a,b)=>a+b,0);

  boxRiepilogo.innerHTML = `
    <div class="sep"><strong>Incassi Totali ‚Ç¨${inc.toFixed(2)}</strong></div>
    ${bloccoTot('inc_dett','Dettaglio incassi',{Contanti:cont,POS:pos,Sardex:sard})}
    ${bloccoTot('f_dett','Food',totNames.food)}
    ${bloccoTot('nf_dett','Non Food',totNames.nonfood)}
    ${bloccoTot('e_dett','Extra',totNames.extra)}
    ${bloccoTot('a_dett','Acconti',totNames.acconti)}
    <div class="sep"><strong>Utile mese ‚Ç¨${(inc - sp).toFixed(2)}</strong></div>
  `;
}

function sommaPerNome(arr,map){
  (arr||[]).forEach(v => { map[v.n] = (map[v.n]||0) + (v.i||0); });
}

function idify(m,i){
  return (m.replace(/[^a-zA-Z0-9]/g,'_')) + '_' + i;
}

function mostraStorico(){
  let html = '';
  const months = Object.keys(db).sort().reverse();
  months.forEach(m=>{
    let days = '';
    db[m].forEach((g,i)=>{
      const sp = ([...(g.food||[]), ...(g.nonfood||[]), ...(g.extra||[])]).reduce((t,x)=>t + (x.i||0),0);
      const net = (g.inc||0) - sp;
      const id = idify(m,i);
      days += `
      <div class="day-card">
        <div class="day-header" onclick="toggle(document.getElementById('${id}'))">
          ${g.data} <span>‚Ç¨${net.toFixed(2)} netto (inc:‚Ç¨${(g.inc||0).toFixed(2)} sp:‚Ç¨${sp.toFixed(2)})</span>
        </div>
        <div class="day-body" id="${id}">
          ${blocco('Food', g.food, m, i, 'food')}
          ${blocco('Non Food', g.nonfood, m, i, 'nonfood')}
          ${blocco('Extra', g.extra, m, i, 'extra')}
          ${blocco('Acconti', g.acconti, m, i, 'acconti')}
        </div>
      </div>`;
    });
    html += `<div class="month-card"><div class="month-header" onclick="toggle(this.nextElementSibling)">${m}</div><div class="month-body">${days}</div></div>`;
  });

  storicoEl.innerHTML = html;
  aggiornaMesi();
}

// inizializza la pagina
mostraStorico();
</script>
</body>
</html>
